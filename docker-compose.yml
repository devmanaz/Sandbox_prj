services:

  # ── Sandbox Execution API ─────────────────────────────────────────────────
  sandbox-api:
    build:
      context: ./sandbox-api
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    volumes:
      # Mount Docker socket so the API can spawn sibling containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount host tmp so we can pass code files into sibling containers
      - /tmp:/tmp
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # ── Runner image build helper ─────────────────────────────────────────────
  # This service exists only to pre-build the sandbox-runner image.
  # It exits immediately after building. The actual runner containers
  # are spawned on-demand by the API (not managed by compose).
  runner-builder:
    build:
      context: ./sandbox-api
      dockerfile: runner.Dockerfile
    image: sandbox-runner   # tag the built image as 'sandbox-runner'
    command: ["echo", "sandbox-runner image ready"]
    profiles:
      - build               # only runs with: docker compose --profile build up
